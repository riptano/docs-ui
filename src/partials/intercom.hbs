{{#with site.keys.intercom}}
<script>
(function() {
  function loadIntercom() {
    // Check for functional consent (category 1)
    if (typeof window.truste !== 'undefined' && window.truste.cma) {
      var consent = window.truste.cma.callApi('getConsent', window.location.href) || {};
      var hasFunctional = consent[1] === 1;

      if (hasFunctional) {
        window.intercomSettings = {
          app_id: "{{this}}",
          api_base: "https://api-iam.intercom.io"
        };

        !function(){var t=window,e=t.Intercom;if("function"==typeof e)e("reattach_activator"),e("update",t.intercomSettings);else{var n=document,a=function(){a.c(arguments)};a.q=[],a.c=function(t){a.q.push(t)},t.Intercom=a;var c=function(){var t=n.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://widget.intercom.io/widget/{{this}}";var e=n.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)};t.attachEvent?t.attachEvent("onload",c):t.addEventListener("load",c,!1)}}();
      }
    }
  }

  // Listen for consent changes
  if (window.addEventListener) {
    window.addEventListener('cm_data_subject_consent_changed', loadIntercom);
    window.addEventListener('cm_consent_preferences_set', loadIntercom);
  }

  // Initial check
  if (document.readyState === 'complete') {
    loadIntercom();
  } else {
    window.addEventListener('load', loadIntercom);
  }
})();
</script>
{{/with}}
